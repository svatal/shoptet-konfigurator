<script>
  function appendNoteOnLastCheckoutStep() {
    setTimeout(() => {
      const naMiru = document.querySelectorAll(
        '.cart-item a[href$="-na-miru/"]'
      );
      if (naMiru.length && document.querySelector("#add-note")) {
        document.querySelector("#add-note").click();
        let note = "";
        const stored = getItemsFromLocalStorage();
        let notFound = [];
        naMiru.forEach((a) => {
          const name = a.innerText;
          const sku = parseInt(
            a.parentElement.parentElement.attributes["data-micro-sku"].value
          );
          const count = parseInt(
            a.parentElement.parentElement.querySelector(".cart-item-amount")
              .innerText
          );
          for (let i = 0; i < count; i++) {
            if (note !== "") note += "\n----------------\n";
            note += name + ":\n";
            const storedProductText = stored[sku]?.pop()?.text;
            if (!storedProductText) notFound.push(name);
            note += storedProductText ?? getTextConfig(sku);
          }
        });
        const remark = document.querySelector("textarea#remark");
        remark.setAttribute("rows", 10);
        remark.setAttribute("cols", 50);
        remark.style.maxWidth = "600px";
        remark.style.height = "300px";
        remark.value = note;
        if (notFound.length)
          alert(
            `Ke zboží ${notFound
              .map((name) => `"${name}"`)
              .join(
                ", "
              )} se nepovedlo najít Váš výběr. Prosím, doplňte jej v poznámce.`
          );
        document
          .querySelector("form#order-form")
          .addEventListener("submit", () => localStorage.clear());
      }
    }, 100);
  }

  function appendConfiguratorOnProductPage() {
    const form = document.querySelector("#product-detail-form");
    if (form !== null) {
      const id = +form.querySelector('input[name="productId"]').value;
      const text = getTextConfig(id);
      if (!text) return;
      const div = document.createElement("div");
      div.className = "variant-list";
      div.innerHTML = `<span class="variant-label">Váš výběr (viz popis níže)</span><textarea class="konfigurace" rows="8" cols="50">${text}</textarea>`;
      const variant = form.querySelector("select#parameter-id-36");
      variant && selectVariant(variant, 4);

      form.insertBefore(div, form.querySelector(".p-price-wrapper"));
      form.addEventListener("submit", () => {
        const free = getFreeLocalStorageId(id.toString());
        localStorage.setItem(
          free.localStorageId,
          form.querySelector(".konfigurace").value
        );
        variant && selectVariant(variant, free.c);
      });
    }
  }

  function selectVariant(select, idx) {
    // select.querySelector(`option[text="${label}"]`)
    select.value = document.querySelector(`option[data-index="${idx}"]`).value;
  }

  /** @param prefix {string} */
  function getFreeLocalStorageId(prefix) {
    prefix += "/";
    let c = 1;
    while (localStorage.getItem(prefix + c)) c++;
    return { localStorageId: prefix + c, c };
  }

  function getItemsFromLocalStorage() {
    /** @type {Record<string, {itemIdx: string, text: string}[]} */
    const r = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      const text = localStorage.getItem(key);
      const [productId, itemIdx] = key.split("/");
      if (r[productId] === undefined) r[productId] = [];
      r[productId].push({ itemIdx, text });
    }
    return r;
  }

  function getTextConfig(id) {
    const c = config.get(id);
    if (!c) return null;
    return [...c, "Vaše poznámka"].map((line) => `${line}: `).join("\n");
  }

  const bVlasky = "barva vlásků";
  const bVlasy = "barva vlasů";
  const bSaticky = "barva šatiček";
  const bTop = "barva topu";
  const bSukenky = "barva sukénky";
  const bSatickyHlavni = "barva šatiček - hlavní";
  const bSatickyDoplnkova = "barva šatiček - doplňková";
  const bKridla = "barva křídel - doplňková k bílé";
  const bDiteVlasky = "barva vlásků dítěte";
  const bDiteObleceni = "barva oblečení dítěte";
  const bTricko = "barva trička";
  const bKalhoty = "barva kalhot";
  const diteVek = "věk dítěte";
  const doplnek = "doplněk do rukou (nakupuje se zvlášť)";
  const uces = "typ účesu";

  const config = new Map([
    [273, [bVlasky, bSaticky]], // drobnenka
    [279, [bVlasky, bTop, bSukenky, doplnek]], // panenka zenskost
    [204, [uces, bVlasky, bSatickyHlavni, bSatickyDoplnkova, bKridla, doplnek]], // vila
    [180, [uces, bVlasky, bSatickyHlavni, bSatickyDoplnkova, doplnek]], // osobni panenka
    [186, [bVlasky, bDiteVlasky, bDiteObleceni]], // andel strazny - holcicka/chlapecek
    [
      183,
      [
        uces,
        bVlasky,
        bSatickyHlavni,
        bSatickyDoplnkova,
        bDiteVlasky,
        bDiteObleceni,
      ],
    ], // maminka s detatkem - holcicka / chlapecek
    [267, [bVlasy, bTricko, bKalhoty, bDiteVlasky, bDiteObleceni, diteVek]], // tatinek s ditetem - holcicka / chlapecek
  ]);

  function modifyThankYouPage() {
    const recap = document.querySelector(".recapitulation-table-payment");
    if (!recap) return;
    recap.style.display = "none";
    recap.parentElement.innerHTML = `<div>Objednávku zatím neplaťte. Překontroluji ji a brzy se Vám ozvu s jejím potvrzením a s doplňujícími informacemi.</div>`;
  }

  appendConfiguratorOnProductPage();
  appendNoteOnLastCheckoutStep();
  modifyThankYouPage();
</script>
