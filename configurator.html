<script>
  function appendNoteOnLastCheckoutStep() {
    setTimeout(() => {
      const naMiru = document.querySelectorAll(
        '.cart-item a[href$="-na-miru/"]'
      );
      if (naMiru.length && document.querySelector("#add-note")) {
        document.querySelector("#add-note").click();
        let note = "";
        const stored = getItemsFromLocalStorage();
        naMiru.forEach((a) => {
          const name = a.innerText;
          const sku = parseInt(
            a.parentElement.parentElement.attributes["data-micro-sku"].value
          );
          const count = parseInt(
            a.parentElement.parentElement.querySelector(".cart-item-amount")
              .innerText
          );
          for (let i = 0; i < count; i++) {
            if (note !== "") note += "\n----------------\n";
            note += name + ":\n";
            note += stored[sku]?.shift().text ?? getTextConfig(sku);
          }
        });
        document.querySelector("#remark").value = note;
      }
    }, 100);
  }

  function appendConfiguratorOnProductPage() {
    const form = document.querySelector("#product-detail-form");
    if (form !== null) {
      const id = +form.querySelector('input[name="productId"]').value;
      const text = getTextConfig(id);
      if (!text) return;
      const div = document.createElement("div");
      div.className = "variant-list";
      div.innerHTML = `<span class="variant-label">Konfigurace</span><textarea class="konfigurace" rows="8" cols="50">${text}</textarea>`;
      form.insertBefore(div, form.querySelector(".p-price-wrapper"));
      form.addEventListener("submit", () => {
        const lsId = getFreeLocalStorageId(id.toString());
        localStorage.setItem(lsId, form.querySelector(".konfigurace").value);
      });
    }
  }

  /** @param prefix {string} */
  function getFreeLocalStorageId(prefix) {
    prefix += "-";
    let c = 1;
    while (localStorage.getItem(prefix + c)) c++;
    return prefix + c;
  }

  function getItemsFromLocalStorage() {
    /** @type {Record<string, {itemIdx: string, text: string}[]} */
    const r = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      const text = localStorage.getItem(key);
      const [productId, itemIdx] = key.split("-");
      if (r[productId] === undefined) r[productId] = [];
      r[productId].push({ itemIdx, text });
    }
    return r;
  }

  function getTextConfig(id) {
    const c = config.get(id);
    if (!c) return null;
    return [...c, "Vaše poznámka"].map((line) => `${line}: `).join("\n");
  }

  const bVlasky = "barva vlásků";
  const bSaticky = "barva šatiček";
  const bTop = "barva topu";
  const bSukenky = "barva sukénky";
  const bSatickyHlavni = "barva šatiček - hlavní";
  const bSatickyDoplnkova = "barva šatiček - doplňková";
  const bKridla = "barva křídel";
  const bDiteVlasky = "barva vlásků dítěte";
  const bDiteObleceni = "barva oblečení dítěte";
  const diteVek = "věk dítěte";
  const doplnek = "doplněk do rukou (nakupuje se zvlášť)";
  const uces = "typ účesu";

  const config = new Map([
    [273, [bVlasky, bSaticky]], // drobnenka
    [279, [bVlasky, bTop, bSukenky, doplnek]], // panenka zenskost
    [204, [uces, bVlasky, bSatickyHlavni, bSatickyDoplnkova, bKridla, doplnek]], // vila
    [180, [uces, bVlasky, bSatickyHlavni, bSatickyDoplnkova, doplnek]], // osobni panenka
    [186, [bVlasky, bDiteVlasky, bDiteObleceni]], // andel strazny - holcicka/chlapecek
    [
      183,
      [
        uces,
        bVlasky,
        bSatickyHlavni,
        bSatickyDoplnkova,
        bDiteVlasky,
        bDiteObleceni,
      ],
    ], // maminka s detatkem - holcicka / chlapecek
    [
      267,
      [
        bVlasky,
        bSatickyHlavni,
        bSatickyDoplnkova,
        bDiteVlasky,
        bDiteObleceni,
        diteVek,
      ],
    ], // tatinek s ditetem - holcicka / chlapecek
  ]);

  appendConfiguratorOnProductPage();
  appendNoteOnLastCheckoutStep();
</script>
